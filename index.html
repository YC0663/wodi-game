<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è°æ˜¯å§åº•</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        :root {
            --p:#3d2b8e; --s:#7c5cbf; --a:#e84393;
            --bg:#f0edf8; --text:#1a1a2e; --sub:#7a7a9a;
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
        body{font-family:'Noto Sans SC',sans-serif;background:var(--bg);min-height:100vh;display:flex;justify-content:center;background-image:radial-gradient(circle at 20% 20%,rgba(124,92,191,.12) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(232,67,147,.10) 0%,transparent 50%)}
        .app{width:100%;max-width:480px;display:flex;flex-direction:column;min-height:100vh}
        .nav{background:linear-gradient(135deg,var(--p),var(--s));color:#fff;padding:16px 20px;font-weight:900;font-size:18px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(61,43,142,.3);letter-spacing:1px}
        .nav .reset-link{font-size:12px;font-weight:400;opacity:.8;cursor:pointer;background:rgba(255,255,255,.15);padding:5px 10px;border-radius:20px}
        .content{flex:1;padding:20px 16px 30px;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .card{width:100%;background:#fff;border-radius:24px;padding:26px 22px;box-shadow:0 8px 32px rgba(61,43,142,.12),0 2px 8px rgba(0,0,0,.06);animation:fadeUp .35s ease}
        @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .hidden{display:none!important}
        h3{color:var(--p);font-size:20px;font-weight:900;margin-bottom:6px;text-align:center}
        h2{color:var(--text);font-size:24px;font-weight:900;text-align:center}

        /* é…ç½® */
        .stat-wrap{text-align:center;margin-bottom:16px}
        .stat{font-size:12px;color:var(--sub);background:#f5f3fc;padding:6px 12px;border-radius:20px;display:inline-block}
        .input-group{width:100%;text-align:left;margin-bottom:18px}
        .input-group label{font-size:13px;color:var(--sub);font-weight:700;letter-spacing:.5px;display:block;margin-bottom:2px}
        .stepper{display:flex;align-items:center;background:#f5f3fc;border-radius:14px;padding:6px;margin-top:8px;gap:4px}
        .stepper button{width:48px;height:48px;border:none;background:#fff;border-radius:10px;font-size:22px;color:var(--p);box-shadow:0 2px 8px rgba(61,43,142,.1);cursor:pointer;transition:transform .1s;font-weight:bold}
        .stepper button:active{transform:scale(.9)}
        .stepper span{flex:1;text-align:center;font-weight:900;font-size:22px;color:var(--p)}

        /* è¯åº“æ¨¡å¼åˆ‡æ¢ */
        .mode-tabs{display:flex;gap:8px;margin-top:8px}
        .mode-tab{flex:1;padding:10px 6px;border-radius:11px;border:2px solid #e0dbf5;background:#faf9ff;font-size:13px;font-weight:700;color:var(--sub);cursor:pointer;text-align:center;transition:all .2s}
        .mode-tab.active{border-color:var(--p);background:linear-gradient(135deg,#f0ecff,#fce8f4);color:var(--p)}

        /* API Key */
        .api-input-wrap{position:relative;margin-top:8px}
        .api-input{width:100%;padding:12px 44px 12px 14px;border:2px solid #e0dbf5;border-radius:12px;font-size:14px;font-family:inherit;color:var(--text);background:#faf9ff;outline:none;transition:border .2s}
        .api-input:focus{border-color:var(--p)}
        .api-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;user-select:none}
        .api-hint{font-size:11px;color:var(--sub);margin-top:6px;line-height:1.6;background:#f5f3fc;padding:8px 10px;border-radius:10px}

        /* æŒ‰é’® */
        .btn{width:100%;padding:15px;background:linear-gradient(135deg,var(--p),var(--s));color:#fff;border:none;border-radius:14px;font-size:17px;font-weight:900;margin-top:12px;cursor:pointer;letter-spacing:1px;box-shadow:0 4px 16px rgba(61,43,142,.3);transition:transform .15s,opacity .2s}
        .btn:active{transform:scale(.97)}
        .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .btn-o{background:transparent;border:2px solid var(--p);color:var(--p);box-shadow:none}

        /* å¼€å§‹å‰åŠ è½½ */
        .loading-overlay{display:none;position:fixed;inset:0;background:rgba(20,10,50,.7);z-index:300;justify-content:center;align-items:center;flex-direction:column;gap:16px}
        .loading-overlay.show{display:flex}
        .loading-text{color:#fff;font-size:16px;font-weight:700;letter-spacing:1px}
        .spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* å‘ç‰Œé¡µ */
        .player-num{font-size:13px;color:var(--sub);text-align:center;margin-bottom:4px;letter-spacing:2px}
        .back-box{text-align:center;padding:30px 20px;margin:18px 0;background:linear-gradient(135deg,#f5f3fc,#ede8f8);border-radius:18px;border:2px dashed rgba(124,92,191,.3)}
        .back-box .card-icon{font-size:64px;margin-bottom:12px;animation:float 3s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .back-box p{color:var(--sub);font-size:14px;line-height:1.8}
        .front-box{text-align:center;animation:reveal .4s ease;margin:18px 0}
        @keyframes reveal{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
        .front-box .label{color:var(--sub);font-size:13px;margin-bottom:10px;letter-spacing:1px}
        .word-box{font-size:38px;font-weight:900;color:var(--a);padding:22px 20px;margin-bottom:12px;background:linear-gradient(135deg,#fff0f6,#ffe8f5);border:2px solid rgba(232,67,147,.2);border-radius:18px;letter-spacing:3px}
        .role-tag{display:inline-block;padding:6px 20px;border-radius:20px;font-size:13px;font-weight:700;letter-spacing:1px;margin-bottom:12px}
        .role-civilian{background:#e8f8f0;color:#27ae60}
        .role-spy{background:#fde8ee;color:var(--a)}
        .progress-wrap{margin:14px 0 4px}
        .progress-label{font-size:12px;color:var(--sub);margin-bottom:6px;display:flex;justify-content:space-between}
        .progress-bar{height:6px;background:#eee;border-radius:3px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(to right,var(--p),var(--a));border-radius:3px;transition:width .4s ease}

        /* AI æç¤ºåŒº */
        .ai-box{background:linear-gradient(135deg,#f0ecff,#fce8f4);border:1.5px solid rgba(124,92,191,.22);border-radius:16px;padding:14px 15px;margin-bottom:14px;text-align:left}
        .ai-box-title{font-size:12px;font-weight:700;color:var(--s);letter-spacing:1px;margin-bottom:10px;display:flex;align-items:center;gap:5px}
        .hint-item{background:#fff;border-radius:10px;padding:9px 12px;margin-bottom:8px;border-left:3px solid var(--s);font-size:13px;color:#333;line-height:1.7}
        .hint-item:last-child{margin-bottom:0}
        .ai-loading{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--sub);padding:4px 0}
        .dot{width:7px;height:7px;border-radius:50%;background:var(--s);animation:bounce 1.2s infinite;display:inline-block}
        .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
        @keyframes bounce{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
        .ai-error{font-size:12px;color:#e74c3c;line-height:1.6}
        .no-api-tip{font-size:12px;color:var(--sub);background:#f5f3fc;padding:10px 14px;border-radius:12px;text-align:center;margin-bottom:14px}

        /* æ¸¸æˆé¡µ */
        .game-top{text-align:center;margin-bottom:16px}
        .game-top p{font-size:13px;color:var(--sub);margin-top:4px}
        .word-pills{display:flex;gap:10px;margin-bottom:14px}
        .word-pill{flex:1;padding:12px 8px;border-radius:14px;text-align:center}
        .word-pill .wlabel{font-size:11px;font-weight:700;letter-spacing:1px;opacity:.7;margin-bottom:3px}
        .word-pill .wval{font-size:18px;font-weight:900;letter-spacing:2px}
        .civilian-pill{background:#e8f8f0;color:#27ae60}
        .spy-pill{background:#fde8ee;color:var(--a)}

        /* æŠ•ç¥¨æ ¼å­ */
        .vote-label{font-size:12px;font-weight:700;color:var(--sub);letter-spacing:1px;margin-bottom:10px;text-align:center}
        .player-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
        .p-chip{position:relative;border-radius:16px;padding:14px 6px 12px;text-align:center;cursor:pointer;border:2px solid #e8e4f5;background:#faf9ff;transition:transform .15s;user-select:none}
        .p-chip:active{transform:scale(.93)}
        .p-chip .chip-icon{font-size:26px;margin-bottom:5px}
        .p-chip .chip-name{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px}
        .p-chip .chip-status{font-size:11px;color:var(--sub)}
        .p-chip.revealed-civilian{background:#e8f8f0;border-color:#27ae60}
        .p-chip.revealed-civilian .chip-name{color:#27ae60}
        .p-chip.revealed-civilian .chip-status{color:#27ae60;font-weight:700}
        .p-chip.revealed-spy{background:#fde8ee;border-color:var(--a)}
        .p-chip.revealed-spy .chip-name{color:var(--a)}
        .p-chip.revealed-spy .chip-status{color:var(--a);font-weight:700}
        .p-chip.eliminated{opacity:.4;filter:grayscale(.5);cursor:default}
        .elim-x{position:absolute;top:5px;right:8px;font-size:13px;color:#e74c3c;font-weight:900}
        .divider{height:1px;background:#f0f0f0;margin:14px 0}

        /* å¼¹çª— */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(20,10,50,.6);z-index:200;justify-content:center;align-items:center}
        .modal-overlay.show{display:flex;animation:fadein .2s ease}
        @keyframes fadein{from{opacity:0}to{opacity:1}}
        .modal-box{background:#fff;border-radius:24px;padding:26px 22px;width:85%;max-width:340px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:popIn .25s cubic-bezier(.34,1.56,.64,1)}
        @keyframes popIn{from{opacity:0;transform:scale(.65)}to{opacity:1;transform:scale(1)}}
        .modal-player{font-size:13px;color:var(--sub);margin-bottom:4px;letter-spacing:1px}
        .modal-name{font-size:24px;font-weight:900;color:var(--text);margin-bottom:16px}
        .modal-result{font-size:20px;font-weight:900;padding:16px 20px;border-radius:16px;margin-bottom:16px;letter-spacing:2px}
        .modal-result.civilian{background:#e8f8f0;color:#27ae60}
        .modal-result.spy{background:#fde8ee;color:var(--a)}
        .modal-btn-row{display:flex;gap:10px}
        .modal-btn{flex:1;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;transition:transform .1s}
        .modal-btn:active{transform:scale(.95)}
        .mbtn-close{background:#f0edf8;color:var(--p)}
        .mbtn-elim{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
    </style>
</head>
<body>
<div class="app">
    <div class="nav">
        <span>ğŸ•µï¸ è°æ˜¯å§åº•</span>
        <span class="reset-link" onclick="clearData()">æ¸…ç©ºå†å²</span>
    </div>
    <div class="content">

        <!-- é¡µé¢1ï¼šé…ç½® -->
        <div id="p1" class="card">
            <h3>æ¸¸æˆé…ç½®</h3>
            <div class="stat-wrap"><span class="stat" id="stat">åŠ è½½ä¸­...</span></div>

            <div class="input-group">
                <label>ğŸ‘¥ ç©å®¶äººæ•°</label>
                <div class="stepper">
                    <button onclick="ctrl('p',-1)">âˆ’</button>
                    <span id="v-p">6</span>
                    <button onclick="ctrl('p',1)">+</button>
                </div>
            </div>

            <div class="input-group">
                <label>ğŸ­ å§åº•äººæ•°</label>
                <div class="stepper">
                    <button onclick="ctrl('s',-1)">âˆ’</button>
                    <span id="v-s">1</span>
                    <button onclick="ctrl('s',1)">+</button>
                </div>
            </div>

            <div class="input-group">
                <label>ğŸ“¦ è¯åº“æ¥æº</label>
                <div class="mode-tabs">
                    <div class="mode-tab active" id="tab-local" onclick="setMode('local')">
                        ğŸ—‚ å†…ç½®è¯åº“<br><span style="font-size:11px;font-weight:400">200+ ç»„ï¼Œç§’å¼€å§‹</span>
                    </div>
                    <div class="mode-tab" id="tab-ai" onclick="setMode('ai')">
                        ğŸ¤– AI å‡ºé¢˜<br><span style="font-size:11px;font-weight:400">æ¯å±€å…¨æ–°è¯ç»„</span>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label>ğŸ”‘ DeepSeek API Key</label>
                <div class="api-input-wrap">
                    <input class="api-input" id="api-key-input" type="password"
                        placeholder="sk-xxxxxxxxxxxxxxxx" oninput="saveApiKey()"/>
                    <span class="api-eye" onclick="toggleKey()">ğŸ‘</span>
                </div>
                <div class="api-hint" id="api-hint-text">
                    âœ¨ å¡«å…¥åå¯è·å¾— <b>AI æè¿°æç¤º</b>ï¼ˆå¸®ä½ ç»„ç»‡è¯­è¨€ï¼‰ã€‚<br>
                    é€‰ã€ŒAI å‡ºé¢˜ã€æ¨¡å¼æ—¶å¿…å¡«ï¼Œå¯†é’¥ä»…å­˜æœ¬åœ°ã€‚
                </div>
            </div>

            <button class="btn" id="start-btn" onclick="startGame()">ğŸƒ å¼€å§‹å‘ç‰Œ</button>
            <button class="btn btn-o" onclick="exitApp()" style="margin-top:10px">é€€å‡ºæ¸¸æˆ</button>
        </div>

        <!-- é¡µé¢2ï¼šå‘ç‰Œ -->
        <div id="p2" class="card hidden">
            <div class="player-num">PLAYER</div>
            <h2 id="p-title">ç©å®¶ 1</h2>
            <div class="progress-wrap">
                <div class="progress-label">
                    <span>å‘ç‰Œè¿›åº¦</span><span id="prog-text">1/6</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>
            </div>

            <div id="back-box" class="back-box">
                <div class="card-icon">ğŸƒ</div>
                <p>è¯·å°†æ‰‹æœºä¼ ç»™è¯¥ç©å®¶<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹è¯è¯­</p>
            </div>

            <div id="front-box" class="front-box hidden">
                <div class="label">ä½ çš„è¯è¯­æ˜¯</div>
                <div class="word-box" id="cur-word">---</div>
                <div id="role-display"></div>
                <div class="ai-box" id="ai-box">
                    <div class="ai-box-title">âœ¨ AI æè¿°æç¤ºï¼ˆä»…ä¾›å‚è€ƒï¼‰</div>
                    <div id="ai-content">
                        <div class="ai-loading">
                            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                            <span style="margin-left:5px">AI æ­£åœ¨ç”Ÿæˆæç¤º...</span>
                        </div>
                    </div>
                </div>
                <div id="no-api-box" class="no-api-tip hidden">
                    ğŸ’¡ å¡«å…¥ DeepSeek API Key å³å¯è·å¾— AI æè¿°æç¤º
                </div>
            </div>

            <button class="btn" id="act-btn" onclick="next()">ğŸ‘ æŸ¥çœ‹è¯è¯­</button>
        </div>

        <!-- é¡µé¢3ï¼šæŠ•ç¥¨ç¿»ç‰Œ -->
        <div id="p3" class="card hidden">
            <div class="game-top">
                <h3>ğŸ® æ¸¸æˆè¿›è¡Œä¸­</h3>
                <p>ç‚¹å‡»ç©å®¶ç‰Œå­æŸ¥çœ‹èº«ä»½ Â· æ·˜æ±°åå¯æ‰“å‰</p>
            </div>
            <div id="word-pills-wrap" class="hidden">
                <div class="word-pills" id="finish-words"></div>
            </div>
            <button class="btn btn-o" id="word-toggle-btn" onclick="toggleWords()"
                style="margin-top:0;margin-bottom:14px;padding:11px;font-size:14px">
                ğŸ‘ æ˜¾ç¤ºè¯è¯­ï¼ˆä¸»æŒäººï¼‰
            </button>
            <div class="vote-label">ğŸ—³ï¸ ç‚¹å‡»ç‰Œå­æŸ¥çœ‹èº«ä»½</div>
            <div class="player-grid" id="player-grid"></div>
            <div class="divider"></div>
            <button class="btn" onclick="location.reload()">ğŸ”„ å†æ¥ä¸€å±€</button>
        </div>

    </div>
</div>

<!-- å…¨å±åŠ è½½é®ç½©ï¼ˆAIå‡ºé¢˜æ—¶ç”¨ï¼‰ -->
<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">AI æ­£åœ¨å‡ºé¢˜ä¸­...</div>
</div>

<!-- ç¿»ç‰Œå¼¹çª— -->
<div class="modal-overlay" id="modal" onclick="closeModalBg(event)">
    <div class="modal-box">
        <div class="modal-player">èº«ä»½æ­æ™“</div>
        <div class="modal-name" id="modal-name"></div>
        <div class="modal-result" id="modal-result"></div>
        <div class="modal-btn-row">
            <button class="modal-btn mbtn-close" onclick="closeModal()">å…³é—­</button>
            <button class="modal-btn mbtn-elim" onclick="eliminatePlayer()">â˜ ï¸ æ ‡è®°æ·˜æ±°</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å†…ç½®è¯åº“ 200+ ç»„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = [
    ["éº¦å½“åŠ³","è‚¯å¾·åŸº"],["æ±‰å ¡","ä¸‰æ˜æ²»"],["å¯ä¹","é›ªç¢§"],["å¥¶èŒ¶","è±†æµ†"],["åŒ…å­","é¥ºå­"],
    ["å…ƒå®µ","æ±¤åœ†"],["çƒ¤è‚‰","ç«é”…"],["éº»è¾£çƒ«","å†’èœ"],["å‡‰çš®","å†·é¢"],["é¢æ¡","ç±³ç²‰"],
    ["é¦’å¤´","èŠ±å·"],["çƒ§é¥¼","æ²¹æ¡"],["æ˜¥å·","éº»èŠ±"],["æœˆé¥¼","ç²½å­"],["é¥¼å¹²","è›‹ç³•"],
    ["é¢åŒ…","ç”œç”œåœˆ"],["å·§å…‹åŠ›","ç³–æœ"],["å†°æ¿€å‡Œ","é›ªç³•"],["å’–å•¡","èŒ¶"],["æœæ±","æ±½æ°´"],
    ["å•¤é…’","ç™½é…’"],["çº¢é…’","é¦™æ§Ÿ"],["ç‰›è‚‰","çŒªè‚‰"],["ç¾Šè‚‰","é¹¿è‚‰"],["é¸¡è‚‰","é¸­è‚‰"],
    ["èƒèŸ¹","é¾™è™¾"],["è±†è…","é­”èŠ‹"],["ç²¥","æ±¤"],["å¯¿å¸","åˆºèº«"],["æ‹‰é¢","ä¹Œå†¬é¢"],
    ["æŠ«è¨","æ„é¢"],["è–¯æ¡","æ´‹èŠ‹ç‰‡"],["ç« é±¼å°ä¸¸å­","é±¼ä¸¸"],
    ["è‹¹æœ","æ¢¨å­"],["è‘¡è„","æå­"],["è¥¿ç“œ","å“ˆå¯†ç“œ"],["è‰è“","è“è“"],["æŸ æª¬","é’æŸ "],
    ["æ¡ƒå­","æå­"],["èŠ’æœ","æœ¨ç“œ"],["è è","å‡¤æ¢¨"],["çŒ•çŒ´æ¡ƒ","å¥‡å¼‚æœ"],["æ©™å­","æ©˜å­"],
    ["æ¦´è²","è èèœœ"],["è½¦å˜å­","æ¨±æ¡ƒ"],["å¤§ç™½èœ","å·å¿ƒèœ"],["é»„ç“œ","ä¸ç“œ"],["èŒ„å­","è‹¦ç“œ"],
    ["è¾£æ¤’","é’æ¤’"],["åœŸè±†","çº¢è–¯"],["æ´‹è‘±","å¤§è‘±"],["å¤§è’œ","ç”Ÿå§œ"],["ç‰ç±³","å±±è¯"],
    ["è²è—•","è¸è "],["è èœ","ç”Ÿèœ"],["èŠ±æ¤°èœ","è¥¿è“èŠ±"],
    ["é£Ÿç›","ç™½ç³–"],["é™ˆé†‹","é…±æ²¹"],["å‘³ç²¾","é¸¡ç²¾"],["èŠ±æ¤’","å…«è§’"],
    ["å¾®ä¿¡","QQ"],["æŠ–éŸ³","å¿«æ‰‹"],["å¾®åš","æ¨ç‰¹"],["ç”µè„‘","å¹³æ¿"],["æ‰‹æœº","åº§æœº"],
    ["è€³æœº","éŸ³å“"],["å……ç”µå®","å……ç”µå™¨"],["è“ç‰™","Wi-Fi"],["é”®ç›˜","é¼ æ ‡"],["å°å¼æœº","ç¬”è®°æœ¬"],
    ["è‹¹æœæ‰‹æœº","å®‰å“æ‰‹æœº"],["æ™ºèƒ½æ‰‹è¡¨","è¿åŠ¨æ‰‹ç¯"],["æ¸¸æˆæœº","æŒæœº"],
    ["æ‘„åƒå¤´","éº¦å…‹é£"],["æŠ•å½±ä»ª","å¤§å±ç”µè§†"],["ç¡¬ç›˜","Uç›˜"],["äºŒç»´ç ","æ¡å½¢ç "],
    ["è‡ªè¡Œè½¦","ç”µåŠ¨è½¦"],["å…¬äº¤è½¦","åœ°é“"],["å‡ºç§Ÿè½¦","ç½‘çº¦è½¦"],["è½®èˆ¹","æ¸¡è½®"],
    ["ç«è½¦","é«˜é“"],["é£æœº","ç›´å‡æœº"],["æ‘©æ‰˜è½¦","ä¸‰è½®è½¦"],["é«˜é€Ÿå…¬è·¯","å›½é“"],["çº¢ç»¿ç¯","æ–‘é©¬çº¿"],
    ["å£çº¢","å”‡è†"],["æ²æµ´éœ²","é¦™çš‚"],["æ´—å‘æ°´","æŠ¤å‘ç´ "],["æ´—è¡£ç²‰","æ´—è¡£æ¶²"],
    ["ç‰™åˆ·","ç‰™è†"],["é›¨ä¼","é›¨è¡£"],["æ‰‹å¥—","å›´å·¾"],["å¸½å­","å¢¨é•œ"],["æ‰‹è¡¨","é—¹é’Ÿ"],
    ["ä¹¦åŒ…","è¡Œæç®±"],["æ²™å‘","æ¿å‡³"],["å°ç¯","è½åœ°ç¯"],["åºŠå•","è¢«ç½©"],["æ¯›å·¾","æµ´å·¾"],
    ["é•œå­","ç»ç’ƒ"],["é’¥åŒ™","å¯†ç é”"],["åƒåœ¾æ¡¶","çº¸ç¯“"],["æ‹–é‹","å‡‰é‹"],["æ•å¤´","é å«"],
    ["é’¢ç¬”","é“…ç¬”"],["åœ†ç ç¬”","æ°´ç¬”"],["æ©¡çš®","ä¿®æ­£æ¶²"],["å°ºå­","åœ†è§„"],["è¯¾æœ¬","ä¹ é¢˜å†Œ"],
    ["å›¾ä¹¦é¦†","ä¹¦åº—"],["é»‘æ¿","ç™½æ¿"],["ç²‰ç¬”","é©¬å…‹ç¬”"],
    ["åŒ»ç”Ÿ","æŠ¤å£«"],["è­¦å¯Ÿ","ä¿å®‰"],["è€å¸ˆ","æ•™æˆ"],["å¾‹å¸ˆ","æ³•å®˜"],["å¨å¸ˆ","é¢ç‚¹å¸ˆ"],
    ["ç¨‹åºå‘˜","äº§å“ç»ç†"],["æ¼”å‘˜","æ­Œæ‰‹"],["è®°è€…","ä¸»æ’­"],["æ¶ˆé˜²å‘˜","æ•‘æ´é˜Ÿå‘˜"],["å¿«é€’å‘˜","å¤–å–å‘˜"],
    ["è·³èˆ","å”±æ­Œ"],["è·‘æ­¥","ç«èµ°"],["æ¸¸æ³³","æ½œæ°´"],["çˆ¬å±±","æ”€å²©"],["ç¯®çƒ","è¶³çƒ"],
    ["æ’çƒ","ç¾½æ¯›çƒ"],["ä¹’ä¹“çƒ","ç½‘çƒ"],["å°çƒ","ä¿é¾„çƒ"],["é«˜å°”å¤«","æ£’çƒ"],
    ["å†²æµª","å¸†æ¿"],["ç‘œä¼½","æ™®æ‹‰æ"],["å¥èº«","è·³ç»³"],
    ["ç”µå½±","ç”µè§†å‰§"],["è¯å‰§","å°å“"],["ç›¸å£°","è„±å£ç§€"],["é­”æœ¯","æ‚æŠ€"],["ä¹¦æ³•","ç»˜ç”»"],
    ["è±¡æ£‹","å›´æ£‹"],["äº”å­æ£‹","é£è¡Œæ£‹"],["æ‰‘å…‹","éº»å°†"],["å¯†å®¤é€ƒè„±","å‰§æœ¬æ€"],
    ["KTV","é…’å§"],["æ¸¸ä¹å›­","æ°´ä¸Šä¹å›­"],["åŠ¨ç‰©å›­","æ¤ç‰©å›­"],
    ["å¤ªé˜³","æœˆäº®"],["æ˜Ÿæ˜Ÿ","æµæ˜Ÿ"],["é›¨æ»´","å†°é›¹"],["åœ°éœ‡","æµ·å•¸"],["æ£®æ—","è‰åŸ"],
    ["æµ·æ´‹","æ¹–æ³Š"],["æ²™æ¼ ","æˆˆå£"],["ç«å±±","æ¸©æ³‰"],["å±±å³°","å±±è°·"],["æ²³æµ","å°æºª"],
    ["æš´é£é›ª","æ²™å°˜æš´"],["å½©è™¹","æå…‰"],["çŠç‘šç¤","æµ·è‰åºŠ"],
    ["è€è™","è±¹å­"],["ç‹®å­","çŒè±¹"],["å¤§è±¡","çŠ€ç‰›"],["é•¿é¢ˆé¹¿","éª†é©¼"],["ç†ŠçŒ«","æµ£ç†Š"],
    ["æµ·è±š","é²¸é±¼"],["é¹¦é¹‰","éº»é›€"],["çŒ«å¤´é¹°","è€é¹°"],["èœœèœ‚","è´è¶"],["é‡‘é±¼","é”¦é²¤"],
    ["ä¹Œé¾Ÿ","æ‰¬å­é³„"],["é›ªè±¹","åŒ—æç†Š"],
    ["ç”·æœ‹å‹","å‰ç”·å‹"],["é—ºèœœ","æ­»å…š"],["åŒå­¦","åŒäº‹"],["æœ‹å‹","ç½‘å‹"],
    ["ç”„å¬›ä¼ ","å»¶ç¦§æ”»ç•¥"],["èœ˜è››ä¾ ","è™è ä¾ "],["èµµæ•","å‘¨èŠ·è‹¥"],["å­™æ‚Ÿç©º","çŒªå…«æˆ’"],
    ["å“ˆåˆ©æ³¢ç‰¹","èµ«æ•"],["é’¢é“ä¾ ","ç¾å›½é˜Ÿé•¿"],["ç™½é›ªå…¬ä¸»","ç°å§‘å¨˜"],
    ["åŒ»é™¢","è¯Šæ‰€"],["å­¦æ ¡","åŸ¹è®­ç­"],["è¶…å¸‚","ä¾¿åˆ©åº—"],["é¤å…","é£Ÿå ‚"],["å…¬å›­","å¹¿åœº"],
    ["æœºåœº","ç«è½¦ç«™"],["é“¶è¡Œ","ATMæœº"],["é…’åº—","æ°‘å®¿"],["å¥èº«æˆ¿","æ¸¸æ³³æ± "],["æ•™å ‚","å¯ºåº™"],
    ["å¦‚æœ","å‡è®¾"],["æ°”æ³¡æ°´","è‹æ‰“æ°´"],["ç¥è¯","ç«¥è¯"],["ç§˜å¯†","éšç§"],["è°è¨€","å€Ÿå£"],
    ["æ¢¦æƒ³","å¹»æƒ³"],["å›å¿†","è®°å¿†"],["ä¹ æƒ¯","çˆ±å¥½"],["èªæ˜","æ™ºæ…§"],["å‹‡æ•¢","æ— ç•"],
    ["æ¸©æŸ”","æŸ”å¼±"],["éª„å‚²","è‡ªä¿¡"],
    ["æ˜¥èŠ‚","å…ƒæ—¦"],["ä¸­ç§‹èŠ‚","ä¸ƒå¤•èŠ‚"],["æ¸…æ˜èŠ‚","å¯’é£ŸèŠ‚"],["åœ£è¯èŠ‚","å¹³å®‰å¤œ"],
    ["ä¸‡åœ£èŠ‚","é¬¼èŠ‚"],["æƒ…äººèŠ‚","æ¯äº²èŠ‚"],
    ["æ„Ÿå†’","æµæ„Ÿ"],["å¤´ç—›","åå¤´ç—›"],["æ‰“é’ˆ","è¾“æ¶²"],["Xå…‰","CTæ‰«æ"],
    ["é•¿åŸ","æ•…å®«"],["åŸƒè²å°”é“å¡”","è‡ªç”±å¥³ç¥åƒ"],["é‡‘å­—å¡”","ç‹®èº«äººé¢åƒ"],["å¤©å®‰é—¨","äººæ°‘å¤§ä¼šå ‚"],
    ["æ——è¢","æ±‰æœ"],["è¥¿è£…","è¡¬è¡«"],["ç‰›ä»”è£¤","ä¼‘é—²è£¤"],["è¿åŠ¨é‹","çš®é‹"],["é«˜è·Ÿé‹","å¹³åº•é‹"],
    ["å©šçº±","æ™šç¤¼æœ"],["ç¾½ç»’æœ","é£è¡£"],["å›´å·¾","é¢†å¸¦"],
    ["è‚¡ç¥¨","åŸºé‡‘"],["é“¶è¡Œå¡","ä¿¡ç”¨å¡"],["ç°é‡‘","æ”¯ä»˜å®"],["è´·æ¬¾","åˆ†æœŸä»˜æ¬¾"],
    ["ç«æŸ´","æ‰“ç«æœº"],["èœ¡çƒ›","ç”µç¯"],["çœ¼é•œ","éšå½¢çœ¼é•œ"],["ç¾ç”²","ç¾å‘"],
    ["çº¹èº«","ç©¿å­”"],["å†¥æƒ³","å‚¬çœ "],["æ˜Ÿåº§","å¡”ç½—ç‰Œ"],["ç®—å‘½","çœ‹ç›¸"],
    ["ç½‘çº¢","æ˜æ˜Ÿ"],["ç›´æ’­","å½•æ’­"],["å¼¹å¹•","è¯„è®º"],["ç‚¹èµ","æ”¶è—"]
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// çŠ¶æ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cfg = { p:6, s:1, mode:'local' };
let state = { list:[], cur:0, show:false, history:[] };
let currentModalId = null;
let currentPair = { civilian:'', spy:'' };

window.onload = () => {
    const h = localStorage.getItem('h_wodi3');
    if (h) state.history = JSON.parse(h);
    const k = localStorage.getItem('ds_api_key');
    if (k) document.getElementById('api-key-input').value = k;
    updateStat();
};

function saveApiKey() {
    localStorage.setItem('ds_api_key', document.getElementById('api-key-input').value.trim());
}
function toggleKey() {
    const el = document.getElementById('api-key-input');
    el.type = el.type === 'password' ? 'text' : 'password';
}
function exitApp() {
    if (confirm("ç¡®å®šé€€å‡ºæ¸¸æˆå—ï¼Ÿ")) {
        window.opener=null; window.open('','_self'); window.close();
        if (navigator.app) navigator.app.exitApp();
    }
}
function ctrl(k, d) {
    cfg[k] += d;
    if (cfg.p < 3) cfg.p = 3;
    if (cfg.p > 12) cfg.p = 12;
    if (cfg.s < 1) cfg.s = 1;
    if (cfg.s >= Math.floor(cfg.p/2)) cfg.s = Math.floor(cfg.p/2)-1;
    if (cfg.s < 1) cfg.s = 1;
    document.getElementById('v-p').innerText = cfg.p;
    document.getElementById('v-s').innerText = cfg.s;
}
function setMode(m) {
    cfg.mode = m;
    document.getElementById('tab-local').classList.toggle('active', m==='local');
    document.getElementById('tab-ai').classList.toggle('active', m==='ai');
}
function updateStat() {
    const avail = DB.length - state.history.length;
    document.getElementById('stat').innerText = `ğŸ“š å†…ç½®è¯åº“ï¼š${avail} / ${DB.length} ç»„å¯ç”¨`;
}
function clearData() {
    if (confirm("ç¡®å®šæ¸…ç©ºè¯åº“å†å²è®°å½•å—ï¼Ÿ")) {
        state.history = [];
        localStorage.setItem('h_wodi3', '[]');
        updateStat();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¼€å§‹æ¸¸æˆå…¥å£
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startGame() {
    const apiKey = (localStorage.getItem('ds_api_key')||'').trim();

    if (cfg.mode === 'ai') {
        if (!apiKey) { alert('AI å‡ºé¢˜æ¨¡å¼éœ€è¦å¡«å…¥ DeepSeek API Keyï¼'); return; }
        showLoading('AI æ­£åœ¨å‡ºé¢˜ä¸­...');
        try {
            const pair = await fetchAiWord(apiKey);
            hideLoading();
            buildGame(pair[0], pair[1]);
        } catch(e) {
            hideLoading();
            alert('AI å‡ºé¢˜å¤±è´¥ï¼š' + e.message + '\n\nè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œï¼Œå·²è‡ªåŠ¨åˆ‡æ¢å†…ç½®è¯åº“ã€‚');
            buildGameFromDB();
        }
    } else {
        buildGameFromDB();
    }
}

function buildGameFromDB() {
    let avail = DB.map((_,i)=>i).filter(i=>!state.history.includes(i));
    if (!avail.length) { state.history=[]; avail=DB.map((_,i)=>i); }
    const rid = avail[Math.floor(Math.random()*avail.length)];
    state.history.push(rid);
    localStorage.setItem('h_wodi3', JSON.stringify(state.history));
    updateStat();
    const pair = DB[rid];
    buildGame(pair[0], pair[1]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI å‡ºé¢˜ â€”â€” è®© DeepSeek ç”Ÿæˆä¸€ç»„æ–°è¯å¯¹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAiWord(apiKey) {
    // éšæœºé€‰ä¸€ä¸ªä¸»é¢˜æ–¹å‘ï¼Œå¢åŠ å¤šæ ·æ€§
    const themes = [
        'æ—¥å¸¸ç”Ÿæ´»ç‰©å“æˆ–é£Ÿç‰©', 'æŠ½è±¡æƒ…æ„Ÿæˆ–æ¦‚å¿µ', 'æµè¡Œæ–‡åŒ–æˆ–å½±è§†', 
        'è‡ªç„¶ç°è±¡æˆ–åœ°ç†', 'èŒä¸šæˆ–èº«ä»½', 'æ—¶ä¸‹æµè¡Œçš„ç½‘ç»œè¯æ±‡æˆ–è¡Œä¸º',
        'è¿åŠ¨æˆ–å¨±ä¹æ´»åŠ¨', 'èŠ‚æ—¥æˆ–ä¹ ä¿—', 'ç§‘æŠ€äº§å“', 'åŠ¨æ¤ç‰©'
    ];
    const theme = themes[Math.floor(Math.random()*themes.length)];

    const prompt = `ä½ æ˜¯ã€Œè°æ˜¯å§åº•ã€æ¸¸æˆå‡ºé¢˜äººã€‚è¯·åœ¨ã€Œ${theme}ã€è¿™ä¸ªæ–¹å‘ï¼Œå‡ºä¸€ç»„è¯è¯­ã€‚

è¦æ±‚ï¼š
1. ä¸¤ä¸ªè¯è¦å±äºåŒä¸€å¤§ç±»ï¼Œä½†æœ‰æ˜æ˜¾åŒºåˆ«
2. éš¾åº¦é€‚ä¸­ï¼šä¸èƒ½å¤ªç®€å•ï¼ˆç§’çŒœï¼‰ï¼Œä¹Ÿä¸èƒ½å¤ªå†·åƒ»
3. ä¸¤ä¸ªè¯çš„ç›¸ä¼¼ç¨‹åº¦è¦è®©äººéš¾ä»¥åˆ¤æ–­ï¼ˆæ¯”å¦‚ã€Œå…ƒå®µã€å’Œã€Œæ±¤åœ†ã€ï¼Œçœ‹èµ·æ¥å·®ä¸å¤šï¼Œæè¿°èµ·æ¥å´æœ‰å¾®å¦™åŒºåˆ«ï¼‰
4. è¯è¯­è¦å£è¯­åŒ–ï¼Œä¸è¦å¤ªå­¦æœ¯
5. ç›´æ¥è¾“å‡ºä¸¤ä¸ªè¯ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œä¸åŠ ä»»ä½•å…¶ä»–å†…å®¹

ç¤ºä¾‹æ ¼å¼ï¼š
æ»‘æ¿,è½®æ»‘`;

    const res = await fetch('https://api.deepseek.com/chat/completions', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},
        body: JSON.stringify({
            model:'deepseek-chat',
            messages:[{role:'user', content:prompt}],
            max_tokens:30,
            temperature:1.2  // é«˜æ¸©åº¦ = æ›´éšæœºæ›´æœ‰åˆ›æ„
        })
    });
    if (!res.ok) {
        const err = await res.json().catch(()=>({}));
        throw new Error(err.error?.message || `HTTP ${res.status}`);
    }
    const data = await res.json();
    const text = (data.choices?.[0]?.message?.content||'').trim();
    // è§£æä¸¤ä¸ªè¯
    const parts = text.split(/[,ï¼Œã€\s]+/).map(s=>s.trim()).filter(s=>s.length>0);
    if (parts.length < 2) throw new Error('AI è¿”å›æ ¼å¼å¼‚å¸¸ï¼š' + text);
    return [parts[0], parts[1]];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ„å»ºæ¸¸æˆï¼ˆæ ¸å¿ƒï¼šéšæœºåˆ†é…å§åº•ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGame(wordA, wordB) {
    // âœ… éšæœºå†³å®šè°æ˜¯å¹³æ°‘è¯ã€è°æ˜¯å§åº•è¯
    const [cw, sw] = Math.random() > 0.5 ? [wordA, wordB] : [wordB, wordA];
    currentPair = { civilian: cw, spy: sw };

    // âœ… å…ˆç”Ÿæˆæ‰€æœ‰ç©å®¶è§’è‰²æ± 
    let pool = [];
    for (let i=0; i<cfg.s; i++) pool.push({ t:'å§åº•', w:sw, isS:true });
    for (let i=0; i<cfg.p-cfg.s; i++) pool.push({ t:'å¹³æ°‘', w:cw, isS:false });

    // âœ… çœŸæ­£éšæœºæ‰“ä¹±ï¼ˆFisher-Yates æ´—ç‰Œç®—æ³•ï¼Œæ¯” sort(random) æ›´å‡åŒ€ï¼‰
    for (let i=pool.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
    }

    state.list = pool.map((x,i) => ({...x, id:i+1, eliminated:false, revealed:false}));
    state.cur = 0;
    showPage('p2');
    render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å‘ç‰Œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
    const p = state.list[state.cur];
    document.getElementById('p-title').innerText = `ç©å®¶ ${p.id}`;
    document.getElementById('cur-word').innerText = p.w;
    const total=state.list.length, cur=state.cur+1;
    document.getElementById('prog-text').innerText = `${cur} / ${total}`;
    document.getElementById('prog-fill').style.width = `${(cur/total)*100}%`;
    document.getElementById('back-box').classList.remove('hidden');
    document.getElementById('front-box').classList.add('hidden');
    document.getElementById('act-btn').innerText = 'ğŸ‘ æŸ¥çœ‹è¯è¯­';
    state.show = false;
}

function next() {
    if (!state.show) {
        const p = state.list[state.cur];
        document.getElementById('back-box').classList.add('hidden');
        document.getElementById('front-box').classList.remove('hidden');

        document.getElementById('role-display').innerHTML = p.isS
            ? '<div class="role-tag role-spy">ğŸ­ ä½ æ˜¯å§åº•</div>'
            : '<div class="role-tag role-civilian">âœ… ä½ æ˜¯å¹³æ°‘</div>';

        const apiKey = (localStorage.getItem('ds_api_key')||'').trim();
        if (apiKey) {
            document.getElementById('ai-box').classList.remove('hidden');
            document.getElementById('no-api-box').classList.add('hidden');
            document.getElementById('ai-content').innerHTML = `
                <div class="ai-loading">
                    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    <span style="margin-left:5px">AI æ­£åœ¨ç”Ÿæˆæç¤º...</span>
                </div>`;
            fetchAiHints(p.w, p.isS, apiKey);
        } else {
            document.getElementById('ai-box').classList.add('hidden');
            document.getElementById('no-api-box').classList.remove('hidden');
        }

        document.getElementById('act-btn').innerText = 'âœ… è®°ä½äº†ï¼Œä¼ ç»™ä¸‹ä¸€ä½';
        state.show = true;
    } else {
        state.cur++;
        if (state.cur < state.list.length) render();
        else finish();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI æè¿°æç¤º
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ‰€æœ‰å¯é€‰æè¿°è§’åº¦ï¼Œæ¯æ¬¡éšæœºæŠ½3ä¸ªä¸åŒçš„
const HINT_ANGLES = [
    'å¤–è§‚/é¢œè‰²/å½¢çŠ¶', 'æ°”å‘³/å‘³é“/è§¦æ„Ÿ', 'ä½¿ç”¨åœºæ™¯/å‡ºç°æ—¶æœº',
    'æƒ…æ„Ÿ/å¿ƒç†æ„Ÿå—', 'å£°éŸ³/åŠ¨ä½œ/çŠ¶æ€', 'å’Œå…¶ä»–äº‹ç‰©çš„å…³ç³»',
    'è®©ä½ è”æƒ³åˆ°ä»€ä¹ˆ', 'ä»€ä¹ˆäºº/ä»€ä¹ˆæ—¶å€™ä¼šç”¨', 'å’Œå®ƒç›¸åæ˜¯ä»€ä¹ˆæ„Ÿè§‰',
    'å¦‚æœå®ƒæ˜¯ä¸ªäººï¼Œæ€§æ ¼æ˜¯ä»€ä¹ˆ', 'ç¬¬ä¸€æ¬¡æ¥è§¦æ—¶çš„æ„Ÿè§‰', 'å®ƒæœ€ç‹¬ç‰¹çš„ä¸€ç‚¹',
];

function pickAngles() {
    return [...HINT_ANGLES].sort(() => Math.random() - 0.5).slice(0, 3);
}

async function fetchAiHints(myWord, isSpy, apiKey) {
    const contentEl = document.getElementById('ai-content');
    const otherWord = isSpy ? currentPair.civilian : currentPair.spy;
    const roleLabel = isSpy ? 'å§åº•' : 'å¹³æ°‘';

    // æ¯æ¬¡éšæœºæŠ½3ä¸ªä¸åŒè§’åº¦ï¼Œä¿è¯æ¯ä¸ªç©å®¶æç¤ºä¸ä¸€æ ·
    const angles = pickAngles();
    const playerIdx = state.cur + 1;

    const prompt = `ã€Œè°æ˜¯å§åº•ã€æ¸¸æˆï¼Œç¬¬ ${playerIdx} å·ç©å®¶ã€‚
è§’è‰²ï¼š${roleLabel}ï¼Œæˆ‘çš„è¯ï¼šã€Œ${myWord}ã€ï¼Œå¦ä¸€ä¸ªè¯ï¼šã€Œ${otherWord}ã€

è¯·ä»ä»¥ä¸‹ 3 ä¸ªè§’åº¦å„å†™ 1 æ¡æè¿°ã€Œ${myWord}ã€çš„å¥å­ï¼š
è§’åº¦1ï¼š${angles[0]}
è§’åº¦2ï¼š${angles[1]}
è§’åº¦3ï¼š${angles[2]}

è¦æ±‚ï¼š
- æ¯æ¡å‡†ç¡®æè¿°ã€Œ${myWord}ã€ï¼ŒåŒæ—¶å¬èµ·æ¥ä¹Ÿåƒåœ¨æè¿°ã€Œ${otherWord}ã€ï¼Œè®©äººåˆ†ä¸æ¸…
- ç»å¯¹ä¸èƒ½å‡ºç°è¯è¯­æœ¬èº«çš„å­—
- æ¯æ¡ä¸è¶…è¿‡ 15 å­—ï¼Œå£è¯­åŒ–è‡ªç„¶
åªè¾“å‡º 3 è¡Œï¼Œä¸åŠ ç¼–å·ã€ä¸åŠ è§’åº¦æ ‡é¢˜ã€ä¸åŠ ä»»ä½•è§£é‡Šã€‚`;

    try {
        const res = await fetch('https://api.deepseek.com/chat/completions', {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},
            body: JSON.stringify({
                model:'deepseek-chat',
                messages:[{role:'user', content:prompt}],
                max_tokens:200,
                temperature:0.95
            })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const text = (data.choices?.[0]?.message?.content||'').trim();
        const lines = text.split('\n').map(l=>l.trim()).filter(l=>l.length>2).slice(0,3);
        if (!lines.length) throw new Error('ç©ºå†…å®¹');
        // æ˜¾ç¤ºè§’åº¦æ ‡ç­¾ + å†…å®¹ï¼Œæ¯ä¸ªç©å®¶çœ‹åˆ°ä¸åŒç»´åº¦çš„æç¤º
        contentEl.innerHTML = lines.map((l,i)=>`
            <div class="hint-item">
                <span style="font-size:10px;color:var(--s);font-weight:700;display:block;margin-bottom:3px;opacity:.8">${angles[i]||''}</span>
                ${l}
            </div>`).join('');
    } catch(e) {
        contentEl.innerHTML = `<div class="ai-error">âš ï¸ è·å–å¤±è´¥ï¼š${e.message}<br><span style="font-size:11px;color:#aaa">è¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œ</span></div>`;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å‘ç‰Œå®Œæ¯• â†’ æŠ•ç¥¨é¡µ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function finish() {
    showPage('p3');
    document.getElementById('finish-words').innerHTML = `
        <div class="word-pill civilian-pill">
            <div class="wlabel">å¹³æ°‘è¯</div><div class="wval">${currentPair.civilian}</div>
        </div>
        <div class="word-pill spy-pill">
            <div class="wlabel">å§åº•è¯</div><div class="wval">${currentPair.spy}</div>
        </div>`;
    renderGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æŠ•ç¥¨æ ¼å­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGrid() {
    const grid = document.getElementById('player-grid');
    grid.innerHTML = '';
    state.list.forEach(p => {
        const chip = document.createElement('div');
        chip.className = 'p-chip';
        if (p.eliminated) {
            chip.classList.add('revealed-'+(p.isS?'spy':'civilian'), 'eliminated');
            chip.innerHTML = `<div class="elim-x">âœ•</div>
                <div class="chip-icon">${p.isS?'ğŸ­':'ğŸ‘¤'}</div>
                <div class="chip-name">ç©å®¶ ${p.id}</div>
                <div class="chip-status">${p.isS?'å§åº•':'å¹³æ°‘'} Â· å·²æ·˜æ±°</div>`;
        } else if (p.revealed) {
            chip.classList.add('revealed-'+(p.isS?'spy':'civilian'));
            chip.innerHTML = `<div class="chip-icon">${p.isS?'ğŸ­':'âœ…'}</div>
                <div class="chip-name">ç©å®¶ ${p.id}</div>
                <div class="chip-status">${p.isS?'å§åº•':'å¹³æ°‘'}</div>`;
            chip.onclick = () => openModal(p.id);
        } else {
            chip.innerHTML = `<div class="chip-icon">ğŸƒ</div>
                <div class="chip-name">ç©å®¶ ${p.id}</div>
                <div class="chip-status">ç‚¹å‡»æŸ¥çœ‹</div>`;
            chip.onclick = () => openModal(p.id);
        }
        grid.appendChild(chip);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç¿»ç‰Œå¼¹çª—ï¼ˆåªæ˜¾ç¤ºå¹³æ°‘/å§åº•ï¼Œä¸æ˜¾ç¤ºè¯è¯­ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(pid) {
    const p = state.list.find(x=>x.id===pid);
    if (!p || p.eliminated) return;
    currentModalId = pid;
    p.revealed = true;
    renderGrid();
    document.getElementById('modal-name').innerText = `ç©å®¶ ${p.id}`;
    const r = document.getElementById('modal-result');
    r.textContent = p.isS ? 'ğŸ­ å§åº•ï¼' : 'âœ… å¹³æ°‘';
    r.className = 'modal-result ' + (p.isS ? 'spy' : 'civilian');
    document.getElementById('modal').classList.add('show');
}
function closeModalBg(e) { if (e.target===document.getElementById('modal')) closeModal(); }
function closeModal() { document.getElementById('modal').classList.remove('show'); currentModalId=null; }
function eliminatePlayer() {
    if (currentModalId===null) return;
    const p = state.list.find(x=>x.id===currentModalId);
    if (p) { p.eliminated=true; p.revealed=true; }
    closeModal(); renderGrid();
}

function toggleWords() {
    const wrap = document.getElementById('word-pills-wrap');
    const btn = document.getElementById('word-toggle-btn');
    wrap.classList.toggle('hidden');
    btn.textContent = wrap.classList.contains('hidden') ? 'ğŸ‘ æ˜¾ç¤ºè¯è¯­ï¼ˆä¸»æŒäººï¼‰' : 'ğŸ™ˆ éšè—è¯è¯­';
}

function showPage(id) {
    ['p1','p2','p3'].forEach(i=>document.getElementById(i).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}
function showLoading(txt) {
    document.getElementById('loading-text').textContent = txt;
    document.getElementById('loading').classList.add('show');
}
function hideLoading() {
    document.getElementById('loading').classList.remove('show');
}
</script>
</body>
</html>
